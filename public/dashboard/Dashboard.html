<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="../assets/img/iconLogo.ico" type="image/x-icon" />
  <title>DashBoard - ISee</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="../css/NavBarSemDescricao.css" />
  <link rel="stylesheet" href="../css/efeitoToltipDescricao.css" />
  <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
  <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
</head>

<body onload="exibirQtdTotalRam(), imgUsuario()">

  <div class="body_dashboard">


    <div class="sessao_grafico_principal">
      <div class="container_title">
        <h1>Dashboard</h1>
        <h6 id="bem_vindo">Bom dia</h6>
        <div id="imagem_user" class="notificacoes">
          <img src="../assets/img/alert.svg">
          <img src="../assets/img/user.svg">
        </div>
      </div>

      <div class="canvas_grafic_bar">
        <canvas id="myBarChart" width="466px" height="290px">

        </canvas>
      </div>
    </div>




    <div class="sessao_filtros">

      <div class="head_filtros">

        <div class="selecao_filtro">
          <h2>Filtro</h2>
          <button id="filtro_ram" onclick="filtrarApenasRam()">RAM</button>
          <button id="filtro_cpu" onclick="filtrarApenasCpu()">CPU</button>
          <button id="filtro_memoria" onclick="filtrarApenasMemoria()">Memória</button>
        </div>

        <div class="selecao_maquina">
          <button class="" onclick="dadosCaixa1()">Caixa 1</button>
          <button onclick="dadosCaixa2()">Caixa 2</button>
          <button onclick="dadosCaixa3()">Caixa 3</button>
          <button onclick="dadosCaixa4()">Caixa 4</button>
          <button onclick="dadosCaixa5()">Caixa 5</button>
          <button onclick="dadosCaixa6()">Caixa 6</button>
        </div>
      </div>



      <div class="container_cards">

        <div class="card">
          <h4 id="titulo_card1">Quantidade de RAM restante </h4>
          <!--AQUI FICA O TITULO DO PRIMEIRO CARD -->
          <h2> 25 GB </h2>
        </div>

        <div class="card">
          <h4 id="titulo_card2">Quantidade de RAM TOTAL </h4>
          <!--AQUI FICA O TITULO DO SEGUNDO CARD -->
          <h2> <span id="quantidadeTotalRam">0</span> GB </h2>
        </div>
      </div>

      <div class="canvas_grafic_rosca_container">
        <div class="grafic_rosca">
          <canvas id="pieChart"></canvas>
        </div>

        <div class="grafic_rosca_infos">
          <div class="titulo_grafico_rosca">
            <h4>Uso diário de RAM</h4>
          </div>
          <div id="cardCaixas">

            <div>
              <div style="background-color: #7d2de2;"></div>
              <p>Caixa 1</p>
            </div>

            <div>
              <div style="background-color:#2DE23F;"></div>
              <p>Caixa 2</p>
            </div>

            <div>
              <div style="background-color:#2DB7E2;"></div>
              <p>Caixa 3</p>
            </div>

            <div>
              <div style="background-color:#E22D63;"></div>
              <p>Caixa 4</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!--NavBar-->
  <div class="container_navbar">
    <div class="navbar_bottom">
      <div class="btn_home" onclick="tela_home()">
        <img
          onclick="window.location.href='./homeFuncionario.html'"
          src="../assets/img/home_icon.svg"
        />
        <h2 style="color: #7d2de2" id="effectlist">Home</h2>
      </div>

      <div
        class="btn_etiqueta"
        onclick="window.location.href='../dashboard/etiquetas.html'">
        <img src="../assets/img/etiqueta_icon.svg" />
        <h2 style="color: #7d2de2" id="effectlist">Etiquetas</h2>
      </div>

      <div class="btn_historico">
        <img src="../assets/img/historico_icon.svg" />
        <h2 style="color: #7d2de2" id="effectlist">Histórico</h2>
      </div>

      <div
        class="btn_dashboard"
        onclick="window.location.href='../dashboard/Dashboard.html'"
      >
        <img src="../assets/img/dashboard_icon.svg" />
        <h2 style="color: #7d2de2" id="effectlist">Dashboard</h2>
      </div>

      <div
        class="btn_alerta"
        onclick="window.location.href='../dashboard/alertas.html'"
      >
        <img src="../assets/img/alertas_icon.png" />
        <h2 style="color: #7d2de2" id="effectlist">Alertas</h2>
      </div>

      <div class="btn_perfil">
        <img
          onclick="window.location.href='../meuPerfil.html'"
          src="../assets/img/userNavbar.svg"
        />
        <h2 style="color: #7d2de2" id="effectlist">Perfil</h2>
      </div>

      <div class="btn_sair">
        <img onclick="sair()" src="../assets/img/sair_icon.png" />
        <h2 style="color: #7d2de2" id="effectlist">Sair</h2>
      </div>
    </div>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="../js/graficosDashboard.js"></script>

<link rel="stylesheet" href="../css/dashboard.css" />


<script>

  var dataAtual = new Date();
  var hora = dataAtual.getHours();
  var nome = sessionStorage.nomeUsuario;
  var bemVindo = document.getElementById("bem_vindo");
  var frase;

  if (hora >= 6 && hora < 13) {
    frase = `Bom dia`;
  } else if (hora >= 13 && hora < 18) {
    frase = `Boa tarde`;
  } else {
    frase = `Boa noite`;
  }

  bem_vindo.innerHTML = `${frase}<span style="color:#7D2DE2;"> ${nome}</span>, hoje a eficiência global é de <span style="color:#7D2DE2;"> 100%</span>`

  function tela_home() {
    if (sessionStorage.cargoUsuario === "Gerente") {
      window.location = "homeGestor.html";
    } else {
      window.location = "homeFuncionario.html";
    }
  }

  function sair() {
    sessionStorage.clear();
    window.location.href = "../login.html";
  }

  function exibirQtdTotalRam() {

    fetch(`/usuarios/exibirQuantidadeTotalRam`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    }).then((resposta) => {
      // saldoConta
      resposta.json().then((data) => {
        console.log(data);
        var ram = data[0].totalRam;
        const resultRam = ram.toString().substr(0, 2);
        //ram = ram && ram.substr(0, 2);
        console.log(resultRam);
        quantidadeTotalRam.innerHTML = resultRam
      })

    }).catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
      finalizarAguardar();
    });
  }

  function filtrarApenasRam() {
    titulo_card1.innerHTML = "Quantidade de RAM restante"
    titulo_card2.innerHTML = "Quantidade de RAM TOTAL"
  }

  function filtrarApenasCpu() {
    titulo_card1.innerHTML = "Quantidade de CPU restante"
    titulo_card2.innerHTML = "Quantidade de CPU TOTAL"
  }

  function filtrarApenasMemoria() {
    titulo_card1.innerHTML = 'Quantidade de Memória restante'
    titulo_card2.innerHTML = 'Quantidade de Memória TOTAL'
  }

  function imgUsuario() {
    var idUsuario = sessionStorage.idUsuario;
    fetch(`/usuarios/imgUsuario/${idUsuario}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((resposta) => {
        resposta.json().then((data) => {
          console.log(data);
          const imagemUser = data[0].imagemPerfilUsuario;


          if (imagemUser == undefined) {
            imagem_user.innerHTML = `
                <img src="../assets/img/alert.svg" />
                <img id="imgUser" src="../assets/img/user.svg">
                `
          } else {
            imagem_user.innerHTML = `
                <img src="../assets/img/alert.svg" />
                <img id="imgUser" src="${data[0].imagemPerfilUsuario}" style="border-radius: 92px; height: 9vh; width: 4.3vw">
                `
          }

        })
      }).catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        finalizarAguardar();
      });
  }

  function dadosCaixa1() {

  }

  function obterDadosGrafico(idMaquina) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idMaquina);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idMaquina) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    yAxisID: 'y-',
                    label: '',
                    borderColor: '#70b0da',
                    backgroundColor: '#70b0da',
                    fill: true,
                    data: []
                },
                {
                    yAxisID: 'y-temperatura',
                    label: 'Temperatura',
                    borderColor: '#FFF',
                    backgroundColor: '#32b9cd8f',
                    fill: true,
                    data: []
                }
            ]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.lm35);
        }

        console.log(JSON.stringify(dados));

        var ctx = myChart.getContext('2d');
        window.grafico_linha = Chart.Line(ctx, {
            data: dados,
            options: {
                responsive: true,
                animation: { duration: 500 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: false,
                    text: 'Dados capturados'
                },
                scales: {
                    yAxes: [{
                        type: 'linear',
                        display: true,
                        position: 'left',
                        id: 'y-temperatura',
                        ticks: {
                            beginAtZero: true,
                            max: 100,
                            min: 0
                        }
                    }, {
                        type: 'linear',
                        display: false,
                        position: 'right',
                        id: 'y-',
                        ticks: {
                            beginAtZero: true,
                            max: 100,
                            min: 0
                        },

                        gridLines: {
                            drawOnChartArea: false,
                        },
                    }],
                }
            }
        });

        setTimeout(() => atualizarGrafico(idMaquina, dados), 2000);
    }

    function atualizarGrafico(idAquario, dados) {

fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico: ${dados}`);

            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
            
            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade
            
            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].lm35); // incluir uma nova medida de temperatura

            window.grafico_linha.update();

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
            
            var tituloAquario = document.getElementById("sensor1")
            var registro1 = novoRegistro[0].lm35
            console.log(registro1) 
            tituloAquario.innerHTML = `<h2>Sensor 1</h2> <h1>${registro1} °C</h1>`

            if (registro1 >= 4.49 && registro1 <= 6.07) {
                sensor1.style.backgroundColor = 'green'
            } else if (registro1 >= 6.08 && registro1 <= 7.47) {

                sensor1.style.backgroundColor = 'yellow'
            } else if (registro1 >= 7.48) {
                sensor1.style.backgroundColor = 'red'
            } else if (registro1 >= 2.54 && registro1 <= 4.48) {
                sensor1.style.backgroundColor = 'blue'
            } else {
                sensor1.style.backgroundColor = 'purple'
            }

            var tituloAquario2 = document.getElementById("sensor2")
            var registro2 = novoRegistro[0].lm35 * 0.35
            tituloAquario2.innerHTML = `<h2>Sensor 2</h2> <h1>${registro2.toFixed(2)} °C</h1>`

            if (registro2 >= 4.49 && registro2 <= 6.07) {
                sensor2.style.backgroundColor = 'green'
            } else if (registro2 >= 6.08 && registro2 <= 7.47) {
                sensor2.style.backgroundColor = 'yellow'
                // notificacaoYellow.innerHTML = `Cuidado Sensor 2 <br> Temperatura esta Esquentando`
                // notificacaoYellow.style.display = 'block'
            } else if (registro2 >= 7.48) {
                sensor2.style.backgroundColor = 'red'
            } else if (registro2 >= 2.54 && registro2 <= 4.48) {
                sensor2.style.backgroundColor = 'blue'
            } else {
                sensor2.style.backgroundColor = 'purple'
            }

            var tituloAquario3 = document.getElementById("sensor3")
            var registro3 = novoRegistro[0].lm35 * 0.3 
            tituloAquario3.innerHTML = `<h2>Sensor 3</h2> <h1>${registro3.toFixed(2)} °C</h1>`

            if (registro3 >= 4.49 && registro3 <= 6.07) {
                sensor3.style.backgroundColor = 'green'
            } else if (registro3 >= 6.08 && registro3 <= 7.47) {
                sensor3.style.backgroundColor = 'yellow'
                // notificacaoYellow.innerHTML = `Cuidado Sensor 3 <br> Temperatura esta Esquentando`
                // notificacaoYellow.style.display = 'block'
            } else if (registro3 >= 7.48) {
                sensor3.style.backgroundColor = 'red'
            } else if (registro3 >= 2.54 && registro3 <= 4.48) {
                sensor3.style.backgroundColor = 'blue'
            } else {
                sensor3.style.backgroundColor = 'purple'
            }

            var tituloAquario4 = document.getElementById("sensor4")
            var registro4 = novoRegistro[0].lm35 * 0.1
            tituloAquario4.innerHTML = `<h2>Sensor 4</h2> <h1>${registro4.toFixed(2)} °C</h1>`

            if (registro4 >= 4.49 && registro4 <= 6.07) {

                sensor4.style.backgroundColor = 'green'

            } else if (registro4 >= 6.08 && registro4 <= 7.47) {

                sensor4.style.backgroundColor = 'yellow'
                // notificacaoYellow.innerHTML = `Cuidado Sensor 4 <br> Temperatura esta Esquentando`
                // notificacaoYellow.style.display = 'block'

            } else if (registro4 >= 7.48) {

                sensor4.style.backgroundColor = 'red'

                // notificacaoRed.innerHTML = `Cuidado Temperatura Quente`
                // notificacaoRed.style.display = 'block'

            } else if (registro4 >= 2.54 && registro4 <= 4.48) {

                sensor4.style.backgroundColor = 'blue'

            } else {

                sensor4.style.backgroundColor = 'purple'

            }

        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}

</script>